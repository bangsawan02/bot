name: Bot Automation Workflows

on:
  repository_dispatch:
    types: [new_url_received]

jobs:
  download-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      PAYLOAD_URL: ${{ github.event.client_payload.url }}
      PAYLOAD_SENDER: ${{ github.event.client_payload.sender }}
      PAYLOAD_MODE: ${{ github.event.client_payload.mode }}
      BOT_TOKEN: ${{ github.event.client_payload.bot_token }}
      GOOGLE_CLIENT_ID: ${{ github.event.client_payload.client_id }}
      GOOGLE_CLIENT_SECRET: ${{ github.event.client_payload.client_secret }}
      DRIVE_REFRESH_TOKEN: ${{ github.event.client_payload.refresh_token }}
      API_ID: ${{ vars.API_ID }}
      API_HASH: ${{ vars.API_HASH }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # =========================================================
      # PYTHON SETUP & CACHE
      # =========================================================
      - name: Set up Python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # =========================================================
      # APT CACHE + DEPENDENCIES (XVFB & MEGATOOLS)
      # =========================================================
      - name: Restore APT Cache
        uses: actions/cache/restore@v3
        id: apt-cache
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-v1-${{ hashFiles('**/main.py') }} # Menggunakan hash file sebagai trigger refresh
          restore-keys: ${{ runner.os }}-apt-v1-

      - name: Install System Dependencies
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y xvfb
          if [[ "${{ env.PAYLOAD_URL }}" == *"mega.nz"* ]]; then
            sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends megatools
          fi

      # =========================================================
      # VENV & PLAYWRIGHT CACHE
      # =========================================================
      - name: Restore Venv & Playwright Cache
        id: restore-cache
        uses: actions/cache/restore@v3
        with:
          path: |
            .venv
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-venv-playwright-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-venv-playwright-

      - name: Setup Python Environment & Playwright
        run: |
          python -m venv .venv
          source .venv/bin/activate
          echo "$GITHUB_WORKSPACE/.venv/bin" >> $GITHUB_PATH
          
          python -m pip install --upgrade pip
          
          # Install requirements jika cache tidak sempurna
          if [ "${{ steps.restore-cache.outputs.cache-hit }}" != "true" ]; then
            pip install -r requirements.txt
            playwright install chromium --with-deps
          else
            # Jika cache hit, pastikan OS deps untuk playwright tetap terinstall (sangat cepat)
            playwright install-deps chromium
          fi

      # =========================================================
      # EXECUTION (DOWNLOAD)
      # =========================================================
      - name: Run Downloader Script
        run: |
          sudo rm -f /tmp/.X99-lock
          sudo rm -f /tmp/.X11-unix/X99
          xvfb-run --auto-servernum --server-args="-screen 0 1280x1024x24" python main.py
        env:
          OWNER_ID: ${{ env.PAYLOAD_SENDER }}
          MEDIAFIRE_PAGE_URL: ${{ env.PAYLOAD_URL }}
          DRIVE_REFRESH_TOKEN: ${{ env.DRIVE_REFRESH_TOKEN }}
          BOT_TOKEN: ${{ env.BOT_TOKEN }}

      - name: Get Downloaded Filename
        id: get_filename
        run: |
          if [ -f "downloaded_filename.txt" ]; then
            FILE_NAME=$(cat downloaded_filename.txt | tr -d '\n')
            echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          else
            echo "file_name=unknown" >> $GITHUB_OUTPUT
          fi

      # =========================================================
      # UPLOAD SECTION
      # =========================================================
      - name: Upload to Telegram
        if: env.PAYLOAD_MODE == 'telegram'
        run: python telegram_upload.py
        env:
          OWNER_ID: ${{ env.PAYLOAD_SENDER }}
          BOT_TOKEN: ${{ env.BOT_TOKEN }}

      - name: Upload to Google Drive
        if: env.PAYLOAD_MODE == 'gdrive'
        run: python upload.py
        env:
          DRIVE_REFRESH_TOKEN: ${{ env.DRIVE_REFRESH_TOKEN }}
          FILENAME: ${{ steps.get_filename.outputs.file_name }}
          GOOGLE_CLIENT_ID: ${{ env.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ env.GOOGLE_CLIENT_SECRET }}

      # =========================================================
      # SAVE CACHES (ALWAYS)
      # =========================================================
      - name: Save Caches
        if: always() && steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            .venv
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-venv-playwright-${{ hashFiles('requirements.txt') }}

      - name: Save APT Cache
        if: always() && steps.apt-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v3
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: ${{ runner.os }}-apt-v1-${{ hashFiles('**/main.py') }}

      - name: Cleanup
        if: always()
        run: |
          sudo rm -rf /var/cache/apt/archives/partial
          sudo rm -rf /var/lib/apt/lists/partial
